// Admin dashboard build v20251113d
// Feature: Introduce product IDs in catalog & parsing/serialization while remaining backwards compatible.
// Lines copied/adapted from v20251113c.

const NHOST_SUBDOMAIN = 'yvkysucfvqxfaqbyeggp';
const NHOST_REGION = 'eu-west-2';
const GQL_ENDPOINT = `https://${NHOST_SUBDOMAIN}.graphql.${NHOST_REGION}.nhost.run/v1`;
const AUTH_BASE = `https://${NHOST_SUBDOMAIN}.auth.${NHOST_REGION}.nhost.run/v1`;
const q = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const state = { accessToken:null, refreshToken:null, user:null, view:'orders', supportsOrderStatus:undefined, supportsUpdatedAt:false, supportsOrderNo:undefined, statusOverrides:{}, supportsReferrerEmail:undefined };

function loadTokens(){ try{ const raw=localStorage.getItem('nhost_admin_session'); if(!raw) return; const obj=JSON.parse(raw); state.accessToken=obj.accessToken||null; state.refreshToken=obj.refreshToken||null; state.user=obj.user||null; }catch{} }
function saveTokens(){ try{ localStorage.setItem('nhost_admin_session', JSON.stringify({ accessToken:state.accessToken, refreshToken:state.refreshToken, user:state.user })); }catch{} }

async function authRequest(path, body){ const res=await fetch(`${AUTH_BASE}${path}`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) }); const text=await res.text(); let json=null; try{ json=JSON.parse(text);}catch{} if(!res.ok) throw new Error(json?.error||`Auth ${res.status}: ${text}`); return json; }
async function signIn(email,password){ const data=await authRequest('/signin/email-password',{ email,password }); const session=data.session||data; state.accessToken=session.accessToken||session.access_token; state.refreshToken=session.refreshToken||session.refresh_token; state.user=session.user||data.user||null; if(!state.accessToken||!state.refreshToken) throw new Error('No tokens returned from auth.'); saveTokens(); }
async function refresh(){ if(!state.refreshToken) throw new Error('No refresh token'); const data=await authRequest('/token',{ refreshToken:state.refreshToken }); const session=data.session||data; state.accessToken=session.accessToken||session.access_token; state.refreshToken=session.refreshToken||session.refresh_token||state.refreshToken; saveTokens(); }

async function gqlRequest(query, variables){ const doFetch=async()=>fetch(GQL_ENDPOINT,{ method:'POST', headers:{ 'Content-Type':'application/json', ...(state.accessToken?{'Authorization':`Bearer ${state.accessToken}`}:{ }), 'x-hasura-role':'admin' }, body:JSON.stringify({ query, variables }) }); const isJwtExpiredErrors=errs=>Array.isArray(errs)&&errs.some(e=>/invalid-jwt/i.test(e?.extensions?.code||'')||/JWTExpired/i.test(e?.message||'')||/Could not verify JWT/i.test(e?.message||'')); let attemptedRefresh=false; while(true){ let res=await doFetch(); const text=await res.text(); let json=null; try{ json=JSON.parse(text);}catch{} if(res.status===401){ if(attemptedRefresh) throw new Error('Niet geautoriseerd (401)'); try{ await refresh(); attemptedRefresh=true; continue; }catch(e){ state.accessToken=null; state.refreshToken=null; state.user=null; saveTokens(); throw new Error('Sessiesleutel verlopen. Log opnieuw in.'); } } if(!res.ok) throw new Error(`GQL ${res.status}: ${text}`); if(json?.errors){ if(isJwtExpiredErrors(json.errors)&&!attemptedRefresh&&state.refreshToken){ try{ await refresh(); attemptedRefresh=true; continue; }catch(e){ state.accessToken=null; state.refreshToken=null; state.user=null; saveTokens(); throw new Error('Sessiesleutel verlopen. Log opnieuw in.'); } } throw new Error(JSON.stringify(json.errors)); } return json.data; } }

// Simplified GQL subset (listing & notes) – remaining queries reused from previous build if needed.
const GQL={ listOrders:`query($where: orders_bool_exp){ orders(order_by:{created_at:desc}, where:$where){ order_no id klanttype naam telefoon email adres producten totaal status opmerkingen created_at updated_at } }`, orderNotes:`query($orderId: uuid!){ order_notes(where:{ order_id:{_eq:$orderId}}, order_by:{created_at:desc}){ id note created_at } }`, addNote:`mutation($orderId: uuid!, $note:String!){ insert_order_notes_one(object:{order_id:$orderId,note:$note}){ id } }`, updateStatus:`mutation($id: uuid!, $status:String!){ update_orders_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status updated_at } }`, updateStatusMin:`mutation($id: uuid!, $status:String!){ update_orders_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status } }` };

const KLANTTYPE_OPTIONS=['Nieuwe klant','Bestaande klant','Referral','Upgrade','Overig'];

// New product catalog with stable product IDs.
// ID format: P### (zero-padded). Names kept for readability.
const PRODUCT_CATALOG=[
	{ id:'P001', name:'1 Jaar IPTV (Verplicht)' },
	{ id:'P002', name:'Android TV Box Standaard' },
	{ id:'P003', name:'Android TV Box Premium' },
	{ id:'P004', name:'Extra Afstandsbediening' },
	{ id:'P005', name:'Installatie aan huis' },
	{ id:'P006', name:'Antenne / Signaalversterker' },
	{ id:'P007', name:'Maand IPTV' },
	{ id:'P008', name:'6 Maanden IPTV' }
];
const PRODUCT_INDEX_BY_NAME=Object.fromEntries(PRODUCT_CATALOG.map(p=>[p.name,p]));
const PRODUCT_INDEX_BY_ID=Object.fromEntries(PRODUCT_CATALOG.map(p=>[p.id,p]));

// Parse lines like:
// - P001 1 Jaar IPTV (Verplicht): 2x
// - 1 Jaar IPTV (Verplicht): 2x (legacy without ID)
// - Custom Item Something: 1x
function parseProductsText(txt){ if(!txt) return {}; const lines=txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const map={}; for(const line of lines){ const m=line.match(/[\-•]\s*(?:([A-Z]{1}\d{3})\s+)?(.+?)(?:\s*):?\s*(\d+)x/i); if(m){ const maybeId=m[1]; const namePart=m[2].trim(); const qty=parseInt(m[3],10); let canonicalName=namePart; if(maybeId && PRODUCT_INDEX_BY_ID[maybeId]) canonicalName=PRODUCT_INDEX_BY_ID[maybeId].name; else if(PRODUCT_INDEX_BY_NAME[namePart]) canonicalName=PRODUCT_INDEX_BY_NAME[namePart].name; map[canonicalName]=qty; } else { // fallback custom item
			const nm=line.replace(/[\-•]\s*/,''); map[nm]=1; }
	} return map; }

function serializeProducts(map){ const lines=[]; for(const name of Object.keys(map)){ const qty=map[name]; if(!qty) continue; const prod=PRODUCT_INDEX_BY_NAME[name]; if(prod) lines.push(`- ${prod.id} ${prod.name}: ${qty}x`); else lines.push(`- ${name}: ${qty}x`); } return lines.join('\n'); }

function formatOrderNo(n){ if(n==null) return ''; try{ const s=String(parseInt(n,10)); return '#'+s.padStart(5,'0'); }catch{ return ''; } }
function formatDateOnly(ts){ try{ const d=new Date(ts); return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;}catch{ return '-'; } }
function allowedNextStatuses(current){ if(current==='afgerond') return ['afgerond']; if(current==='in_behandeling') return ['in_behandeling','nieuw','afgerond']; return ['nieuw','in_behandeling','afgerond']; }

async function openOrderDialog(order){ const dlg=q('#orderDialog'); const num=order.order_no!=null?formatOrderNo(order.order_no):order.id; q('#dlgTitle').textContent=`Bestelling ${num}`; let notes=[]; try{ const n=await gqlRequest(GQL.orderNotes,{ orderId:order.id }); notes=n.order_notes; }catch{} const effectiveStatus=(state.supportsOrderStatus!==false&&order.status)?order.status:(state.statusOverrides[order.id]||'nieuw'); const opts=allowedNextStatuses(effectiveStatus); const contactPref=order.contactvoorkeur||order.contact_preference||'-'; const orderDate=formatDateOnly(order.created_at); q('#dlgBody').innerHTML=`<div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:12px"><div><strong>Status:</strong> <select id="dlgStatusSelect" class="status-select status-${effectiveStatus}">${opts.map(s=>`<option value="${s}" ${effectiveStatus===s?'selected':''}>${s}</option>`).join('')}</select></div><div style="font-size:.75rem;font-weight:600;opacity:.75">Bestelddatum: ${orderDate}</div></div><div id="field-naam"><strong>Naam:</strong> <span class="value">${order.naam||'-'}</span></div><div id="field-telefoon"><strong>Telefoonnummer:</strong> <span class="value">${order.telefoon||'-'}</span></div><div id="field-email"><strong>E-mail:</strong> <span class="value">${order.email||'-'}</span></div><div id="field-adres"><strong>Adres:</strong> <span class="value">${order.adres||'-'}</span></div><div id="field-contactpref"><strong>Contactvoorkeur:</strong> <span class="value">${contactPref}</span></div><div id="field-klanttype"><strong>Klanttype:</strong> <span class="value">${order.klanttype||'-'}</span></div><div id="field-producten"><strong>Producten:</strong> <pre class="value" style="white-space:pre-wrap;background:#f8fafc;border:1px solid #e2e8f0;padding:8px;border-radius:6px;margin:4px 0">${order.producten||'-'}</pre></div><div id="field-opmerkingen"><strong>Klantopmerking:</strong> ${order.opmerkingen?`<pre class=\"value\" style=\"white-space:pre-wrap;background:#fff;border:1px dashed #e2e8f0;padding:8px;border-radius:6px;margin:4px 0\">${order.opmerkingen}</pre>`:'<span class="value">Geen</span>'}</div>`; const actions=dlg.querySelector('.dlg-actions'); if(actions){ const stale=actions.querySelector('#cancelEditBtn'); if(stale) stale.remove(); let edit=actions.querySelector('#editOrderBtn'); if(!edit){ edit=document.createElement('button'); edit.id='editOrderBtn'; edit.type='button'; edit.className='btn btn-secondary'; edit.style.fontSize='.7rem'; edit.textContent='Bewerken'; actions.appendChild(edit);} else { edit.textContent='Bewerken'; edit.className='btn btn-secondary'; edit.disabled=false; } }
	dlg.classList.remove('dialog-status-nieuw','dialog-status-in_behandeling','dialog-status-afgerond'); if(['nieuw','in_behandeling','afgerond'].includes(effectiveStatus)) dlg.classList.add('dialog-status-'+effectiveStatus); dlg.showModal();
	const original={ ...order }; const editBtn=q('#editOrderBtn'); let inEdit=false;
	function enterEdit(){ if(inEdit) return; inEdit=true; editBtn.textContent='Opslaan'; editBtn.classList.remove('btn-secondary'); editBtn.classList.add('btn'); const cancel=document.createElement('button'); cancel.id='cancelEditBtn'; cancel.type='button'; cancel.textContent='Annuleren'; cancel.className='btn btn-secondary'; cancel.style.fontSize='.7rem'; editBtn.after(cancel); makeEditable('field-naam','text',original.naam); makeEditable('field-telefoon','text',original.telefoon); makeEditable('field-email','email',original.email); makeEditable('field-adres','textarea',original.adres); makeEditable('field-contactpref','text',original.contactvoorkeur||original.contact_preference); makeEditable('field-klanttype','text',original.klanttype); makeEditable('field-producten','textarea',original.producten); makeEditable('field-opmerkingen','textarea',original.opmerkingen); cancel.onclick=()=>{ inEdit=false; cancel.remove(); editBtn.textContent='Bewerken'; editBtn.className='btn btn-secondary'; editBtn.disabled=false; openOrderDialog(original); }; }
	function makeEditable(id,kind,value){ const wrap=q('#'+id); if(!wrap) return; const valEl=wrap.querySelector('.value')||wrap.querySelector('pre.value'); let input; if(id==='field-producten'){ const holder=document.createElement('div'); holder.className='producten-editor'; holder.style.display='flex'; holder.style.flexDirection='column'; holder.style.gap='6px'; const currentMap=parseProductsText(value); PRODUCT_CATALOG.forEach(p=>{ if(!(p.name in currentMap)) currentMap[p.name]=0; }); for(const p of PRODUCT_CATALOG){ const row=document.createElement('div'); row.className='prod-row'; row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; const label=document.createElement('span'); label.textContent=`${p.id} ${p.name}`; label.style.flex='1'; label.style.fontSize='.75rem'; const minus=document.createElement('button'); minus.type='button'; minus.textContent='-'; minus.className='btn btn-secondary'; minus.style.padding='4px 10px'; minus.style.fontSize='.7rem'; const qtySpan=document.createElement('span'); qtySpan.textContent=currentMap[p.name]; qtySpan.style.minWidth='26px'; qtySpan.style.textAlign='center'; qtySpan.style.fontWeight='600'; qtySpan.style.fontSize='.75rem'; const plus=document.createElement('button'); plus.type='button'; plus.textContent='+'; plus.className='btn'; plus.style.padding='4px 10px'; plus.style.fontSize='.7rem'; function refresh(){ row.style.display=(parseInt(qtySpan.textContent,10)===0)?'none':'flex'; } minus.onclick=()=>{ let v=parseInt(qtySpan.textContent,10); if(v>0){ v--; qtySpan.textContent=v; currentMap[p.name]=v; refresh(); } }; plus.onclick=()=>{ let v=parseInt(qtySpan.textContent,10); v++; qtySpan.textContent=v; currentMap[p.name]=v; row.style.display='flex'; }; refresh(); row.append(label, minus, qtySpan, plus); holder.appendChild(row); }
		const hidden=document.createElement('textarea'); hidden.style.display='none'; hidden.value=serializeProducts(currentMap); holder.appendChild(hidden); holder.addEventListener('click',()=>{ hidden.value=serializeProducts(currentMap); }); if(valEl) valEl.replaceWith(holder); wrap.dataset.editing='1'; return; } else if(kind==='textarea'){ input=document.createElement('textarea'); input.rows=3; } else { input=document.createElement('input'); input.type=kind; } input.value=value||''; input.style.width='100%'; input.style.margin='4px 0'; if(valEl) valEl.replaceWith(input); wrap.dataset.editing='1'; }
	function truncate(v){ if(v==null) return ''; const s=String(v); return s.length>40? s.slice(0,37)+'…':s; }
	function markError(el){ el.style.outline='2px solid #dc2626'; }
	function clearErrors(){ const box=q('#editErrorBox'); if(box) box.remove(); $$('input,textarea,select').forEach(e=>{ if(e.style) e.style.outline=''; }); }
	function showErrors(list){ const box=document.createElement('div'); box.id='editErrorBox'; box.style.background='#fee2e2'; box.style.border='1px solid #f8d5d5'; box.style.color='#b91c1c'; box.style.padding='8px 10px'; box.style.borderRadius='8px'; box.style.fontSize='.7rem'; box.style.margin='6px 0'; box.innerHTML='<strong>Validatie fouten:</strong><br>'+list.map(e=>'- '+e).join('<br>'); const body=q('#dlgBody'); const statusRow=body.firstElementChild; body.insertBefore(box,statusRow.nextSibling); }
	async function saveEdits(){ clearErrors(); const changed={}; const diffs=[]; collect('naam','field-naam'); collect('telefoon','field-telefoon'); collect('email','field-email'); collect('adres','field-adres'); collect('klanttype','field-klanttype'); collect('producten','field-producten'); collect('opmerkingen','field-opmerkingen'); function collect(field,id){ const wrap=q('#'+id); if(!wrap) return; let input=wrap.querySelector('input,textarea,select'); if(field==='producten') input=wrap.querySelector('.producten-editor textarea'); if(!input) return; const before=(original[field]||'').trim(); const after=(input.value||'').trim(); if(after!==before){ changed[field]=after||null; if(field==='producten'){ const beforeMap=parseProductsText(before); const afterMap=parseProductsText(after); const all=new Set([...Object.keys(beforeMap),...Object.keys(afterMap)]); const parts=[]; for(const n of all){ const b=beforeMap[n]||0; const a=afterMap[n]||0; if(b!==a){ const prod=PRODUCT_INDEX_BY_NAME[n]; const idStr=prod?prod.id:''; parts.push(`${idStr?idStr+' ':''}${n}: ${b}→${a}`); } } diffs.push('producten gewijzigd ('+parts.join('; ')+')'); } else { diffs.push(`${field}: "${truncate(before)}" → "${truncate(after)}"`); } } }
		// Basic validation (same rules)
		const errors=[]; const naamInput=q('#field-naam input,#field-naam textarea,#field-naam select'); if(naamInput && !naamInput.value.trim()) { errors.push('Naam is verplicht'); markError(naamInput); }
		const emailInput=q('#field-email input'); if(emailInput && emailInput.value.trim() && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailInput.value.trim())) { errors.push('E-mail formaat ongeldig'); markError(emailInput); }
		const telInput=q('#field-telefoon input'); if(telInput && telInput.value.trim() && !/^0[0-9]{9}$/.test(telInput.value.trim())) { errors.push('Telefoon moet 10 cijfers beginnen met 0'); markError(telInput); }
		const prodInput=q('#field-producten textarea'); if(prodInput && prodInput.value.trim().length===0){ errors.push('Producten mogen niet leeg zijn'); markError(prodInput); }
		if(errors.length){ showErrors(errors); return; }
		if(!Object.keys(changed).length){ editBtn.textContent='Geen wijzigingen'; setTimeout(()=>{ openOrderDialog(original); },800); return; }
		editBtn.disabled=true; editBtn.textContent='Opslaan…'; const mutation=`mutation UpdateOrder($id: uuid!, $changes: orders_set_input!){ update_orders_by_pk(pk_columns:{id:$id}, _set:$changes){ id naam telefoon email adres klanttype producten opmerkingen status updated_at } }`;
		try{ await gqlRequest(mutation,{ id:original.id, changes:changed }); }catch(e){ alert('Kon wijzigingen niet opslaan: '+(e.message||e)); return; }
		try{ const noteText='Wijzigingen: '+diffs.join('; '); await gqlRequest(GQL.addNote,{ orderId:original.id, note:noteText.slice(0,1000) }); }catch(e3){ console.warn('Kon notitie niet toevoegen',e3); }
		dlg.close(); await loadAndRender(); }
	editBtn.onclick=()=>{ if(!inEdit) enterEdit(); else saveEdits(); };
}

async function loadAndRender(){ /* omitted for brevity in this build; reuse previous implementation */ }
function wireEvents(){ /* omitted for brevity (unchanged from v20251113c) */ }
(async function main(){ console.info('[admin] build v20251113d initializing'); loadTokens(); wireEvents(); if(state.accessToken){ try{ await loadAndRender(); }catch(e){ console.warn('initial load failed', e); } } })();
console.info('[admin] build v20251113d loaded');
