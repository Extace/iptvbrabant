// Admin dashboard build v20251113f
// Adds Team members management (list, create, role & active toggle)

const NHOST_SUBDOMAIN = 'yvkysucfvqxfaqbyeggp';
const NHOST_REGION = 'eu-west-2';
const GQL_ENDPOINT = `https://${NHOST_SUBDOMAIN}.graphql.${NHOST_REGION}.nhost.run/v1`;
const AUTH_BASE = `https://${NHOST_SUBDOMAIN}.auth.${NHOST_REGION}.nhost.run/v1`;
const q = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const state = {
  accessToken:null,
  refreshToken:null,
  user:null,
  view:'orders',
  productsCache:[],
  teamCache:[],
};

function loadTokens(){ try{ const raw=localStorage.getItem('nhost_admin_session'); if(!raw) return; const obj=JSON.parse(raw); state.accessToken=obj.accessToken||null; state.refreshToken=obj.refreshToken||null; state.user=obj.user||null; }catch{} }
function saveTokens(){ try{ localStorage.setItem('nhost_admin_session', JSON.stringify({ accessToken:state.accessToken, refreshToken:state.refreshToken, user:state.user })); }catch{} }

async function authRequest(path, body){ const res=await fetch(`${AUTH_BASE}${path}`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) }); const text=await res.text(); let json=null; try{ json=JSON.parse(text);}catch{} if(!res.ok){ throw new Error(json?.error||`Auth ${res.status}: ${text}`); } return json; }
async function signIn(email,password){ const data=await authRequest('/signin/email-password',{ email,password }); const session=data.session||data; state.accessToken=session.accessToken||session.access_token; state.refreshToken=session.refreshToken||session.refresh_token; state.user=session.user||data.user||null; if(!state.accessToken||!state.refreshToken) throw new Error('No tokens returned from auth.'); saveTokens(); }
async function refresh(){ if(!state.refreshToken) throw new Error('No refresh token'); const data=await authRequest('/token',{ refreshToken:state.refreshToken }); const session=data.session||data; state.accessToken=session.accessToken||session.access_token; state.refreshToken=session.refreshToken||session.refresh_token||state.refreshToken; saveTokens(); }

async function gqlRequest(query, variables){ const doFetch=async()=>{ const headers={'Content-Type':'application/json'}; if(state.accessToken) headers['Authorization']=`Bearer ${state.accessToken}`; if(window.__ADMIN_SECRET) headers['x-hasura-admin-secret']=window.__ADMIN_SECRET; return fetch(GQL_ENDPOINT,{ method:'POST', headers, body:JSON.stringify({ query, variables }) }); }; let attemptedRefresh=false; while(true){ const res=await doFetch(); const text=await res.text(); let json=null; try{ json=JSON.parse(text);}catch{} if(res.status===401){ if(attemptedRefresh) throw new Error('Niet geautoriseerd (401)'); try{ await refresh(); attemptedRefresh=true; continue; }catch(e){ state.accessToken=null; state.refreshToken=null; state.user=null; saveTokens(); throw new Error('Sessiesleutel verlopen. Log opnieuw in.'); } } if(!res.ok) throw new Error(`GQL ${res.status}: ${text}`); if(json?.errors) throw new Error(json.errors[0]?.message||JSON.stringify(json.errors)); return json.data; } }

const GQL={
  listOrders:`query($where: orders_bool_exp){ orders(order_by:{created_at:desc}, where:$where){ id order_no naam telefoon email klanttype adres producten totaal status opmerkingen created_at updated_at } }`,
  orderByPk:`query($id: uuid!){ orders_by_pk(id:$id){ id order_no naam telefoon email klanttype adres producten totaal status opmerkingen created_at updated_at } }`,
  orderNotes:`query($orderId: uuid!){ order_notes(where:{order_id:{_eq:$orderId}}, order_by:{created_at:desc}){ id note created_at } }`,
  addNote:`mutation($orderId: uuid!, $note:String!){ insert_order_notes_one(object:{order_id:$orderId,note:$note}){ id } }`,
  updateStatus:`mutation($id: uuid!, $status:String!){ update_orders_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status updated_at } }`,
  updateStatusMin:`mutation($id: uuid!, $status:String!){ update_orders_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status } }`,
  listProducts:`query{ products(order_by:{created_at:desc}){ id product_no name description price_cents active created_at updated_at } }`,
  insertProduct:`mutation($obj: products_insert_input!){ insert_products_one(object:$obj){ id } }`,
  updateProduct:`mutation($id: uuid!, $set: products_set_input!){ update_products_by_pk(pk_columns:{id:$id}, _set:$set){ id } }`,
  listTeam:`query{ team_members(order_by:{created_at:desc}){ id user_id name email role active created_at updated_at } }`,
  insertTeam:`mutation($obj: team_members_insert_input!){ insert_team_members_one(object:$obj){ id } }`,
  updateTeam:`mutation($id: uuid!, $set: team_members_set_input!){ update_team_members_by_pk(pk_columns:{id:$id}, _set:$set){ id } }`,
};

function show(el){ el.classList.remove('hidden'); } function hide(el){ el.classList.add('hidden'); }
function formatOrderNo(n){ if(n==null) return ''; try{ return '#'+String(parseInt(n,10)).padStart(5,'0'); }catch{ return ''; } }
function formatDateOnly(ts){ try{ const d=new Date(ts); return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;}catch{ return '-'; } }
function allowedNextStatuses(current){ if(current==='afgerond') return ['afgerond']; if(current==='in_behandeling') return ['in_behandeling','nieuw','afgerond']; return ['nieuw','in_behandeling','afgerond']; }

// Orders
async function loadOrders(){ const search=q('#searchInput').value?.trim(); const pattern=search?`%${search}%`:'%'; const statusVal=q('#statusFilter').value||null; const where={}; if(statusVal) where.status={ _eq:statusVal }; if(pattern && pattern!=='%'){ where._or=[{ naam:{ _ilike:pattern } },{ email:{ _ilike:pattern } },{ telefoon:{ _ilike:pattern } }]; } let data; try{ data=await gqlRequest(GQL.listOrders,{ where }); }catch(e){ q('#ordersContainer').innerHTML=`<div class='panel' style='color:#b91c1c'>${e.message||e}</div>`; return; } renderOrders(data.orders,true); }
function renderOrders(list,supportsStatus){ const c=q('#ordersContainer'); if(!list||!list.length){ c.innerHTML='<div class="panel">Geen resultaten</div>'; return; } const groups={nieuw:[],in_behandeling:[],afgerond:[]}; for(const o of list){ const s=(supportsStatus&&o.status)?o.status:'nieuw'; (groups[s]||groups.nieuw).push(o);} const cmp=(a,b)=>new Date(b.created_at)-new Date(a.created_at); for(const k of Object.keys(groups)) groups[k].sort(cmp); function card(o){ const num=o.order_no!=null?formatOrderNo(o.order_no):''; const effectiveStatus=(supportsStatus&&o.status)?o.status:'nieuw'; const opts=allowedNextStatuses(effectiveStatus); return `<div class='order-card status-${effectiveStatus}' data-id='${o.id}'><h3>${num||'(zonder nummer)'}</h3><div class='status-corner'><select class='status-select status-${effectiveStatus}' data-order-id='${o.id}'>${opts.map(s=>`<option value='${s}' ${s===effectiveStatus?'selected':''}>${s}</option>`).join('')}</select></div><div class='row'><strong>Naam:</strong> ${o.naam||'-'}</div><div class='row'><strong>Telefoon:</strong> ${o.telefoon||'-'}</div><div class='row'><strong>E-mail:</strong> ${o.email||'-'}</div><div class='row'><strong>Datum:</strong> ${formatDateOnly(o.created_at)}</div><div class='row'><strong>Klanttype:</strong> ${o.klanttype||'-'}</div><div class='actions' style='margin-top:8px'><button class='btn' data-act='detail'>Details</button></div></div>`;} function section(label,arr,key){ if(!arr.length) return ''; return `<section class='group-section' data-group='${key}'><div class='group-header'>${label} <span class='count-badge'>${arr.length}</span></div><div class='group-grid'>${arr.map(card).join('')}</div></section>`;} c.innerHTML=[section('Nieuw',groups.nieuw,'nieuw'),section('In behandeling',groups.in_behandeling,'in_behandeling'),section('Afgerond',groups.afgerond,'afgerond')].join(''); }
async function openOrderDialog(id){ let res; try{ res=await gqlRequest(GQL.orderByPk,{ id }); }catch(e){ alert('Kon bestelling laden: '+(e.message||e)); return; } const order=res.orders_by_pk; if(!order) return; let notes=[]; try{ const n=await gqlRequest(GQL.orderNotes,{ orderId:id }); notes=n.order_notes; }catch{} const date=formatDateOnly(order.created_at); q('#dlgTitle').textContent=`Bestelling ${order.order_no!=null?formatOrderNo(order.order_no):order.id}`; q('#dlgBody').innerHTML=`<div style='margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:12px'><div><strong>Status:</strong> <select id='dlgStatusSelect' class='status-select status-${order.status||'nieuw'}'>${allowedNextStatuses(order.status||'nieuw').map(s=>`<option value='${s}' ${s===order.status?'selected':''}>${s}</option>`).join('')}</select></div><div style='font-size:.75rem;font-weight:600;opacity:.75'>Bestelddatum: ${date}</div></div><div><strong>Naam:</strong> ${order.naam||'-'}</div><div><strong>Telefoon:</strong> ${order.telefoon||'-'}</div><div><strong>E-mail:</strong> ${order.email||'-'}</div><div><strong>Adres:</strong> ${order.adres||'-'}</div><div><strong>Producten (legacy):</strong><pre style='white-space:pre-wrap;background:#f8fafc;border:1px solid #e2e8f0;padding:8px;border-radius:6px;margin:4px 0'>${order.producten||'-'}</pre></div><div><strong>Opmerkingen klant:</strong> ${order.opmerkingen||'Geen'}</div><hr/><div class='note-box'><textarea id='noteInput' rows='3' placeholder='Interne notitie toevoegen...'></textarea><button id='addNoteBtn' class='btn'>Toevoegen</button></div><div class='notes-list'>${notes.map(n=>`<div class='note-item'>${n.note}<div class='timestamp'>${new Date(n.created_at).toLocaleString()}</div></div>`).join('')}</div>`; const dlg=q('#orderDialog'); dlg.showModal(); q('#addNoteBtn').onclick=async()=>{ const note=q('#noteInput').value.trim(); if(!note) return; await gqlRequest(GQL.addNote,{ orderId:id, note:note.slice(0,1000) }); dlg.close(); await loadOrders(); }; q('#dlgStatusSelect').onchange=async ev=>{ const next=ev.target.value; try{ await gqlRequest(GQL.updateStatus,{ id, status:next }); }catch(e){ if(/updated_at/i.test(e.message||'')){ await gqlRequest(GQL.updateStatusMin,{ id, status:next }); } } dlg.close(); await loadOrders(); }; }

// Products
async function loadProducts(){ let data; try{ data=await gqlRequest(GQL.listProducts,{}); }catch(e){ q('#productsContainer').innerHTML=`<div class='panel' style='color:#b91c1c'>${e.message||e}</div>`; return; } state.productsCache=data.products; renderProducts(data.products); }
function renderProducts(list){ const c=q('#productsContainer'); if(!list||!list.length){ c.innerHTML='<div class="panel">Geen producten</div>'; return; } const rows=list.map(p=>`<tr data-id='${p.id}'><td>${p.product_no}</td><td>${p.name}</td><td>${p.description?escapeHtml(p.description.slice(0,60)):'-'}</td><td>${p.price_cents!=null?formatPrice(p.price_cents):'-'}</td><td><span class='status-pill ${p.active?'on':'off'}'>${p.active?'Actief':'Inactief'}</span></td><td><button class='btn btn-secondary' data-act='edit'>Bewerken</button> <button class='btn' data-act='toggle'>${p.active?'Deactiveer':'Activeer'}</button></td></tr>`).join(''); c.innerHTML=`<div class='panel'><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:6px'><h3 style='margin:0;font-size:1rem'>Productcatalogus</h3><button id='newProductBtn' class='btn'>Nieuw product</button></div><div class='responsive-table'><table class='prod-table'><thead><tr><th>Nr</th><th>Naam</th><th>Beschrijving</th><th>Prijs</th><th>Status</th><th>Acties</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; c.querySelector('#newProductBtn').onclick=()=>openProductDialog(); c.querySelectorAll('button[data-act]').forEach(b=>b.onclick=handleProductAction); }
function handleProductAction(ev){ const btn=ev.currentTarget; const tr=btn.closest('tr'); const id=tr?.dataset?.id; if(!id) return; const p=state.productsCache.find(x=>x.id===id); if(!p) return; if(btn.dataset.act==='edit') openProductDialog(p); else if(btn.dataset.act==='toggle') toggleProductActive(p); }
async function toggleProductActive(prod){ try{ await gqlRequest(GQL.updateProduct,{ id:prod.id, set:{ active:!prod.active } }); await loadProducts(); }catch(e){ alert('Kon status niet wijzigen: '+(e.message||e)); } }
function openProductDialog(prod){ const dlg=q('#productDialog'); const isEdit=!!prod; q('#productDlgTitle').textContent=isEdit?`Product bewerken (${prod.product_no})`:'Nieuw product'; const nextNo=computeNextProductNo(); const productNo=isEdit?prod.product_no:nextNo; q('#productDlgBody').innerHTML=`<div class='form-row'><label>Product nummer</label><input id='pNo' type='text' value='${productNo}' ${isEdit?'disabled':''}/></div><div class='form-row'><label>Naam</label><input id='pName' type='text' value='${isEdit?escapeAttr(prod.name):''}' required/></div><div class='form-row'><label>Beschrijving</label><textarea id='pDesc' rows='3'>${isEdit?escapeHtml(prod.description||''):''}</textarea></div><div class='form-row'><label>Prijs (€)</label><input id='pPrice' type='number' min='0' step='0.01' value='${isEdit&&prod.price_cents!=null?(prod.price_cents/100).toFixed(2):''}'/></div><div class='form-row'><label>Status</label><select id='pActive'><option value='true' ${!isEdit||prod.active?'selected':''}>Actief</option><option value='false' ${isEdit&&!prod.active?'selected':''}>Inactief</option></select></div>`; dlg.showModal(); q('#productCancelBtn').onclick=()=>dlg.close(); q('#productSaveBtn').onclick=()=>saveProduct(prod); }
function computeNextProductNo(){ const nos=state.productsCache.map(p=>p.product_no).filter(n=>/^P\d{3}$/.test(n)); let max=0; for(const n of nos){ const v=parseInt(n.slice(1),10); if(v>max) max=v; } return 'P'+String(max+1).padStart(3,'0'); }
async function saveProduct(existing){ const dlg=q('#productDialog'); const name=q('#pName').value.trim(); if(!name){ alert('Naam verplicht'); return; } const desc=q('#pDesc').value.trim(); const active=q('#pActive').value==='true'; const priceRaw=q('#pPrice').value.trim(); const priceCents=priceRaw?Math.round(parseFloat(priceRaw.replace(',','.'))*100):null; if(existing){ try{ await gqlRequest(GQL.updateProduct,{ id:existing.id, set:{ name, description:desc||null, price_cents:priceCents, active } }); }catch(e){ alert('Kon product niet bijwerken: '+(e.message||e)); return; } } else { const product_no=q('#pNo').value.trim(); try{ await gqlRequest(GQL.insertProduct,{ obj:{ product_no, name, description:desc||null, price_cents:priceCents, active } }); }catch(e){ alert('Kon product niet maken: '+(e.message||e)); return; } } dlg.close(); await loadProducts(); }

// Team Members
async function loadTeam(){ let data; try{ data=await gqlRequest(GQL.listTeam,{}); }catch(e){ q('#teamContainer').innerHTML=`<div class='panel' style='color:#b91c1c'>${e.message||e}</div>`; return; } state.teamCache=data.team_members; renderTeam(data.team_members); }
function renderTeam(list){ const c=q('#teamContainer'); if(!list||!list.length){ c.innerHTML=`<div class='panel'><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:6px'><h3 style='margin:0;font-size:1rem'>Team leden</h3><button id='newTeamBtn' class='btn'>Nieuw team lid</button></div><div>Geen team leden</div></div>`; c.querySelector('#newTeamBtn').onclick=()=>openTeamDialog(); return; } const rows=list.map(m=>`<tr data-id='${m.id}'><td>${m.name}</td><td>${m.email}</td><td>${m.role}</td><td><span class='status-pill ${m.active?'on':'off'}'>${m.active?'Actief':'Inactief'}</span></td><td>${formatDateOnly(m.created_at)}</td><td><button class='btn btn-secondary' data-act='edit'>Bewerken</button> <button class='btn' data-act='toggle'>${m.active?'Deactiveer':'Activeer'}</button></td></tr>`).join(''); c.innerHTML=`<div class='panel'><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:6px'><h3 style='margin:0;font-size:1rem'>Team leden</h3><button id='newTeamBtn' class='btn'>Nieuw team lid</button></div><div class='responsive-table'><table class='team-table'><thead><tr><th>Naam</th><th>E-mail</th><th>Rol</th><th>Status</th><th>Aangemaakt</th><th>Acties</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; c.querySelector('#newTeamBtn').onclick=()=>openTeamDialog(); c.querySelectorAll('button[data-act]').forEach(b=>b.onclick=handleTeamAction); }
function handleTeamAction(ev){ const btn=ev.currentTarget; const tr=btn.closest('tr'); const id=tr?.dataset?.id; if(!id) return; const m=state.teamCache.find(x=>x.id===id); if(!m) return; if(btn.dataset.act==='edit') openTeamDialog(m); else if(btn.dataset.act==='toggle') toggleTeamActive(m); }
async function toggleTeamActive(m){ try{ await gqlRequest(GQL.updateTeam,{ id:m.id, set:{ active:!m.active } }); await loadTeam(); }catch(e){ alert('Kon status wijzigen: '+(e.message||e)); } }
function openTeamDialog(member){ const dlg=q('#teamDialog'); const isEdit=!!member; q('#teamDlgTitle').textContent=isEdit?`Team lid bewerken (${member.email})`:'Nieuw team lid'; const roles=['admin','support','viewer']; q('#teamDlgBody').innerHTML=`<div class='form-row'><label>Naam</label><input id='tName' type='text' value='${isEdit?escapeAttr(member.name):''}' required/></div><div class='form-row'><label>E-mail</label><input id='tEmail' type='email' value='${isEdit?escapeAttr(member.email):''}' ${isEdit?'disabled':''} required/></div><div class='form-row'><label>Rol</label><select id='tRole'>${roles.map(r=>`<option value='${r}' ${isEdit&&member.role===r?'selected':''}>${r}</option>`).join('')}</select></div><div class='form-row'><label>Status</label><select id='tActive'><option value='true' ${!isEdit||member.active?'selected':''}>Actief</option><option value='false' ${isEdit&&!member.active?'selected':''}>Inactief</option></select></div>`; dlg.showModal(); q('#teamCancelBtn').onclick=()=>dlg.close(); q('#teamSaveBtn').onclick=()=>saveTeam(member); }
async function saveTeam(existing){ const dlg=q('#teamDialog'); const name=q('#tName').value.trim(); const email=q('#tEmail').value.trim(); const role=q('#tRole').value; const active=q('#tActive').value==='true'; if(!name||!email){ alert('Naam en e-mail verplicht'); return; } if(existing){ try{ await gqlRequest(GQL.updateTeam,{ id:existing.id, set:{ name, role, active } }); }catch(e){ alert('Kon team lid bijwerken: '+(e.message||e)); return; } } else { try{ await gqlRequest(GQL.insertTeam,{ obj:{ name, email, role, active } }); }catch(e){ alert('Kon team lid maken: '+(e.message||e)); return; } } dlg.close(); await loadTeam(); }

function escapeHtml(s){ return (s||'').replace(/[&<>\"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/'/g,'&#39;'); }
function formatPrice(c){ return '€'+(c/100).toFixed(2).replace('.',','); }

function setActiveTab(){ $$('.tabbar .tab').forEach(b=>b.classList.remove('active')); if(state.view==='orders') q('#tabOrders').classList.add('active'); else if(state.view==='customers') q('#tabCustomers').classList.add('active'); else if(state.view==='products') q('#tabProducts').classList.add('active'); else if(state.view==='team') q('#tabTeam').classList.add('active'); }

async function renderView(){ if(state.view==='orders'){ show(q('#statusSummary')); show(q('#ordersContainer')); hide(q('#customersContainer')); hide(q('#productsContainer')); hide(q('#teamContainer')); await loadOrders(); } else if(state.view==='customers'){ hide(q('#statusSummary')); hide(q('#ordersContainer')); show(q('#customersContainer')); hide(q('#productsContainer')); hide(q('#teamContainer')); q('#customersContainer').innerHTML='<div class="panel">(Klanten nog niet geïmplementeerd in deze build)</div>'; } else if(state.view==='products'){ hide(q('#statusSummary')); hide(q('#ordersContainer')); hide(q('#customersContainer')); show(q('#productsContainer')); hide(q('#teamContainer')); await loadProducts(); } else if(state.view==='team'){ hide(q('#statusSummary')); hide(q('#ordersContainer')); hide(q('#customersContainer')); hide(q('#productsContainer')); show(q('#teamContainer')); await loadTeam(); } }

function wireEvents(){ const doLogin=async()=>{ const email=q('#email').value.trim(); const pwd=q('#password').value; const msg=q('#authMsg'); msg.textContent='Bezig met inloggen...'; msg.className='msg'; try{ await signIn(email,pwd); msg.textContent='Ingelogd'; msg.className='msg success'; hide(q('#authSection')); show(q('#appSection')); await renderView(); }catch(e){ msg.textContent='Login fout: '+(e.message||String(e)); msg.className='msg error'; } }; q('#loginBtn').onclick=e=>{ e.preventDefault(); doLogin(); }; q('#authForm')?.addEventListener('submit',e=>{ e.preventDefault(); doLogin(); }); q('#logoutBtn').onclick=()=>{ state.accessToken=null; state.refreshToken=null; state.user=null; saveTokens(); hide(q('#appSection')); show(q('#authSection')); const msg=q('#authMsg'); msg.textContent='Uitgelogd'; msg.className='msg'; }; q('#refreshBtn').onclick=()=>renderView(); q('#tabOrders').onclick=()=>{ state.view='orders'; setActiveTab(); renderView(); }; q('#tabCustomers').onclick=()=>{ state.view='customers'; setActiveTab(); renderView(); }; q('#tabProducts').onclick=()=>{ state.view='products'; setActiveTab(); renderView(); }; q('#tabTeam').onclick=()=>{ state.view='team'; setActiveTab(); renderView(); }; q('#ordersContainer').addEventListener('click', ev=>{ const btn=ev.target.closest('button[data-act=detail]'); if(!btn) return; const card=ev.target.closest('.order-card'); const id=card?.dataset?.id; if(!id) return; openOrderDialog(id); }); q('#ordersContainer').addEventListener('change', async ev=>{ const sel=ev.target.closest('select.status-select'); if(!sel) return; const id=sel.getAttribute('data-order-id'); const next=sel.value; try{ await gqlRequest(GQL.updateStatus,{ id, status:next }); }catch(e){ if(/updated_at/i.test(e.message||'')){ await gqlRequest(GQL.updateStatusMin,{ id, status:next }); } else alert('Kon status niet wijzigen: '+(e.message||e)); } await loadOrders(); }); }

(async function main(){ console.info('[admin] build v20251113f initializing'); loadTokens(); wireEvents(); if(state.accessToken){ hide(q('#authSection')); show(q('#appSection')); try{ await renderView(); }catch(e){ console.warn('initial load failed',e); } } })();
console.info('[admin] build v20251113f loaded');
