// Admin dashboard build v20251113g
// Adds CRM module placeholders: Analytics, Support, Documentation, Integrations.
// Only scaffolding; functionality to be implemented later.

const NHOST_SUBDOMAIN='yvkysucfvqxfaqbyeggp';
const NHOST_REGION='eu-west-2';
const GQL_ENDPOINT=`https://${NHOST_SUBDOMAIN}.graphql.${NHOST_REGION}.nhost.run/v1`;
const AUTH_BASE=`https://${NHOST_SUBDOMAIN}.auth.${NHOST_REGION}.nhost.run/v1`;
const q=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

const state={ accessToken:null, refreshToken:null, user:null, view:'orders', productsCache:[], teamCache:[] };
function loadTokens(){ try{ const raw=localStorage.getItem('nhost_admin_session'); if(!raw) return; const o=JSON.parse(raw); state.accessToken=o.accessToken||null; state.refreshToken=o.refreshToken||null; state.user=o.user||null; }catch{} }
function saveTokens(){ try{ localStorage.setItem('nhost_admin_session', JSON.stringify({ accessToken:state.accessToken, refreshToken:state.refreshToken, user:state.user })); }catch{} }
async function authRequest(path,body){ const r=await fetch(`${AUTH_BASE}${path}`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}) }); const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch{} if(!r.ok) throw new Error(j?.error||`Auth ${r.status}: ${t}`); return j; }
async function signIn(email,password){ const data=await authRequest('/signin/email-password',{ email,password }); const s=data.session||data; state.accessToken=s.accessToken||s.access_token; state.refreshToken=s.refreshToken||s.refresh_token; state.user=s.user||data.user||null; if(!state.accessToken||!state.refreshToken) throw new Error('No tokens returned'); saveTokens(); }
async function refresh(){ if(!state.refreshToken) throw new Error('No refresh token'); const data=await authRequest('/token',{ refreshToken:state.refreshToken }); const s=data.session||data; state.accessToken=s.accessToken||s.access_token; state.refreshToken=s.refreshToken||s.refresh_token||state.refreshToken; saveTokens(); }
async function gqlRequest(query,variables){ const doFetch=async()=>{ const h={'Content-Type':'application/json'}; if(state.accessToken) h['Authorization']=`Bearer ${state.accessToken}`; if(window.__ADMIN_SECRET) h['x-hasura-admin-secret']=window.__ADMIN_SECRET; return fetch(GQL_ENDPOINT,{ method:'POST', headers:h, body:JSON.stringify({ query, variables }) }); }; let tried=false; while(true){ const r=await doFetch(); const txt=await r.text(); let j=null; try{ j=JSON.parse(txt);}catch{} if(r.status===401){ if(tried) throw new Error('Niet geautoriseerd'); try{ await refresh(); tried=true; continue; }catch(e){ state.accessToken=null; state.refreshToken=null; state.user=null; saveTokens(); throw new Error('Sessiesleutel verlopen.'); } } if(!r.ok) throw new Error(`GQL ${r.status}: ${txt}`); if(j?.errors) throw new Error(j.errors[0]?.message||JSON.stringify(j.errors)); return j.data; } }

// Minimal queries reused from previous build (orders & products & team).
const GQL={ listOrders:`query($where: orders_bool_exp){ orders(order_by:{created_at:desc}, where:$where){ id order_no naam telefoon email klanttype adres producten totaal status opmerkingen created_at updated_at } }`, orderByPk:`query($id: uuid!){ orders_by_pk(id:$id){ id order_no naam telefoon email klanttype adres producten totaal status opmerkingen created_at updated_at } }`, orderNotes:`query($orderId: uuid!){ order_notes(where:{order_id:{_eq:$orderId}}, order_by:{created_at:desc}){ id note created_at } }`, addNote:`mutation($orderId: uuid!, $note:String!){ insert_order_notes_one(object:{order_id:$orderId,note:$note}){ id } }`, updateStatus:`mutation($id: uuid!, $status:String!){ update_orders_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status updated_at } }`, updateStatusMin:`mutation($id: uuid!, $status:String!){ update_orders_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status } }`, listProducts:`query{ products(order_by:{created_at:desc}){ id product_no name description price_cents active created_at updated_at } }`, listTeam:`query{ team_members(order_by:{created_at:desc}){ id name email role active created_at updated_at } }` };

function show(e){ e.classList.remove('hidden'); } function hide(e){ e.classList.add('hidden'); }
function formatOrderNo(n){ if(n==null) return ''; return '#'+String(parseInt(n,10)).padStart(5,'0'); }
function formatDateOnly(ts){ try{ const d=new Date(ts); return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;}catch{ return '-'; } }
function allowedNextStatuses(cur){ if(cur==='afgerond') return ['afgerond']; if(cur==='in_behandeling') return ['in_behandeling','nieuw','afgerond']; return ['nieuw','in_behandeling','afgerond']; }

async function loadOrders(){ const search=q('#searchInput').value?.trim(); const pattern=search?`%${search}%`:'%'; const status=q('#statusFilter').value||null; const where={}; if(status) where.status={ _eq:status }; if(pattern && pattern!=='%'){ where._or=[{ naam:{ _ilike:pattern } },{ email:{ _ilike:pattern } },{ telefoon:{ _ilike:pattern } }]; } let data; try{ data=await gqlRequest(GQL.listOrders,{ where }); }catch(e){ q('#ordersContainer').innerHTML=`<div class='panel' style='color:#b91c1c'>${e.message||e}</div>`; return; } renderOrders(data.orders,true); }
function renderOrders(list,supports){ const c=q('#ordersContainer'); if(!list||!list.length){ c.innerHTML='<div class="panel">Geen resultaten</div>'; return; } const groups={nieuw:[],in_behandeling:[],afgerond:[]}; for(const o of list){ const s=(supports&&o.status)?o.status:'nieuw'; (groups[s]||groups.nieuw).push(o);} const cmp=(a,b)=>new Date(b.created_at)-new Date(a.created_at); Object.keys(groups).forEach(k=>groups[k].sort(cmp)); function card(o){ const num=o.order_no!=null?formatOrderNo(o.order_no):''; const st=(supports&&o.status)?o.status:'nieuw'; const opts=allowedNextStatuses(st); return `<div class='order-card status-${st}' data-id='${o.id}'><h3>${num||'(zonder nummer)'}</h3><div class='status-corner'><select class='status-select status-${st}' data-order-id='${o.id}'>${opts.map(s=>`<option value='${s}' ${s===st?'selected':''}>${s}</option>`).join('')}</select></div><div class='row'><strong>Naam:</strong> ${o.naam||'-'}</div><div class='row'><strong>Telefoon:</strong> ${o.telefoon||'-'}</div><div class='row'><strong>E-mail:</strong> ${o.email||'-'}</div><div class='row'><strong>Datum:</strong> ${formatDateOnly(o.created_at)}</div><div class='row'><strong>Klanttype:</strong> ${o.klanttype||'-'}</div><div class='actions' style='margin-top:8px'><button class='btn' data-act='detail'>Details</button></div></div>`;} function section(lbl,arr,key){ if(!arr.length) return ''; return `<section class='group-section' data-group='${key}'><div class='group-header'>${lbl} <span class='count-badge'>${arr.length}</span></div><div class='group-grid'>${arr.map(card).join('')}</div></section>`;} c.innerHTML=[section('Nieuw',groups.nieuw,'nieuw'),section('In behandeling',groups.in_behandeling,'in_behandeling'),section('Afgerond',groups.afgerond,'afgerond')].join(''); }
async function openOrderDialog(id){ let res; try{ res=await gqlRequest(GQL.orderByPk,{ id }); }catch(e){ alert('Kon bestelling laden: '+(e.message||e)); return; } const o=res.orders_by_pk; if(!o) return; let notes=[]; try{ const n=await gqlRequest(GQL.orderNotes,{ orderId:id }); notes=n.order_notes; }catch{} const date=formatDateOnly(o.created_at); q('#dlgTitle').textContent=`Bestelling ${o.order_no!=null?formatOrderNo(o.order_no):o.id}`; q('#dlgBody').innerHTML=`<div style='margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:12px'><div><strong>Status:</strong> <select id='dlgStatusSelect' class='status-select status-${o.status||'nieuw'}'>${allowedNextStatuses(o.status||'nieuw').map(s=>`<option value='${s}' ${s===o.status?'selected':''}>${s}</option>`).join('')}</select></div><div style='font-size:.75rem;font-weight:600;opacity:.75'>Bestelddatum: ${date}</div></div><div><strong>Naam:</strong> ${o.naam||'-'}</div><div><strong>Telefoon:</strong> ${o.telefoon||'-'}</div><div><strong>E-mail:</strong> ${o.email||'-'}</div><div><strong>Adres:</strong> ${o.adres||'-'}</div><div><strong>Producten:</strong><pre style='white-space:pre-wrap;background:#f8fafc;border:1px solid #e2e8f0;padding:8px;border-radius:6px;margin:4px 0'>${o.producten||'-'}</pre></div><div><strong>Opmerkingen klant:</strong> ${o.opmerkingen||'Geen'}</div><hr/><div class='note-box'><textarea id='noteInput' rows='3' placeholder='Interne notitie toevoegen...'></textarea><button id='addNoteBtn' class='btn'>Toevoegen</button></div><div class='notes-list'>${notes.map(n=>`<div class='note-item'>${n.note}<div class='timestamp'>${new Date(n.created_at).toLocaleString()}</div></div>`).join('')}</div>`; const dlg=q('#orderDialog'); dlg.showModal(); q('#addNoteBtn').onclick=async()=>{ const note=q('#noteInput').value.trim(); if(!note) return; await gqlRequest(GQL.addNote,{ orderId:id, note:note.slice(0,1000) }); dlg.close(); await loadOrders(); }; q('#dlgStatusSelect').onchange=async ev=>{ const next=ev.target.value; try{ await gqlRequest(GQL.updateStatus,{ id, status:next }); }catch(e){ if(/updated_at/i.test(e.message||'')){ await gqlRequest(GQL.updateStatusMin,{ id, status:next }); } } dlg.close(); await loadOrders(); }; }

async function loadProducts(){ let d; try{ d=await gqlRequest(GQL.listProducts,{}); }catch(e){ q('#productsContainer').innerHTML=`<div class='panel' style='color:#b91c1c'>${e.message||e}</div>`; return; } state.productsCache=d.products; q('#productsContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Producten (placeholder)</h3><div>Totaal: ${d.products.length}</div></div>`; }
async function loadTeam(){ let d; try{ d=await gqlRequest(GQL.listTeam,{}); }catch(e){ q('#teamContainer').innerHTML=`<div class='panel' style='color:#b91c1c'>${e.message||e}</div>`; return; } state.teamCache=d.team_members; q('#teamContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Team (placeholder)</h3><div>Leden: ${d.team_members.length}</div></div>`; }
function loadAnalytics(){ q('#analyticsContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Analytics & Reporting</h3><div>Placeholder module – toekomstige grafieken en KPI's.</div></div>`; }
function loadSupport(){ q('#supportContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Support & Service</h3><div>Placeholder module – tickets, SLA's, contactmomenten.</div></div>`; }
function loadDocs(){ q('#docsContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Documentatie & Notities</h3><div>Placeholder module – gedeelde knowledge base & interne notities.</div></div>`; }
function loadIntegrations(){ q('#integrationsContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Integraties & Automatisering</h3><div>Placeholder module – API keys, webhooks, workflow automation.</div></div>`; }

function setActiveTab(){ $$('.tabbar .tab').forEach(b=>b.classList.remove('active')); const id='tab'+state.view.charAt(0).toUpperCase()+state.view.slice(1); const el=q('#'+id); if(el) el.classList.add('active'); }
async function renderView(){ const v=state.view; ['orders','customers','products','team','analytics','support','docs','integrations'].forEach(name=>{ const el=q('#'+name+'Container'); if(!el) return; if(name===v) show(el); else hide(el); }); if(v==='orders'){ show(q('#statusSummary')); await loadOrders(); } else hide(q('#statusSummary')); if(v==='products') await loadProducts(); if(v==='team') await loadTeam(); if(v==='analytics') loadAnalytics(); if(v==='support') loadSupport(); if(v==='docs') loadDocs(); if(v==='integrations') loadIntegrations(); if(v==='customers'){ q('#customersContainer').innerHTML=`<div class='panel'><h3 style='margin:0 0 6px'>Klanten</h3><div>Placeholder module – klantdetails & abonnementen.</div></div>`; } }

function wireEvents(){ const doLogin=async()=>{ const email=q('#email').value.trim(); const pwd=q('#password').value; const msg=q('#authMsg'); msg.textContent='Bezig met inloggen...'; msg.className='msg'; try{ await signIn(email,pwd); msg.textContent='Ingelogd'; msg.className='msg success'; hide(q('#authSection')); show(q('#appSection')); await renderView(); }catch(e){ msg.textContent='Login fout: '+(e.message||String(e)); msg.className='msg error'; } }; q('#loginBtn').onclick=e=>{ e.preventDefault(); doLogin(); }; q('#authForm')?.addEventListener('submit',e=>{ e.preventDefault(); doLogin(); }); q('#logoutBtn').onclick=()=>{ state.accessToken=null; state.refreshToken=null; state.user=null; saveTokens(); hide(q('#appSection')); show(q('#authSection')); const msg=q('#authMsg'); msg.textContent='Uitgelogd'; msg.className='msg'; }; q('#refreshBtn').onclick=()=>renderView(); ['Orders','Customers','Products','Team','Analytics','Support','Docs','Integrations'].forEach(name=>{ const btn=q('#tab'+name); if(btn) btn.onclick=()=>{ state.view=name.toLowerCase(); setActiveTab(); renderView(); }; }); q('#ordersContainer').addEventListener('click', ev=>{ const btn=ev.target.closest('button[data-act=detail]'); if(!btn) return; const card=ev.target.closest('.order-card'); const id=card?.dataset?.id; if(!id) return; openOrderDialog(id); }); q('#ordersContainer').addEventListener('change', async ev=>{ const sel=ev.target.closest('select.status-select'); if(!sel) return; const id=sel.getAttribute('data-order-id'); const next=sel.value; try{ await gqlRequest(GQL.updateStatus,{ id, status:next }); }catch(e){ if(/updated_at/i.test(e.message||'')){ await gqlRequest(GQL.updateStatusMin,{ id, status:next }); } else alert('Kon status niet wijzigen: '+(e.message||e)); } await loadOrders(); }); }

(async function main(){ console.info('[admin] build v20251113g initializing'); loadTokens(); wireEvents(); if(state.accessToken){ hide(q('#authSection')); show(q('#appSection')); try{ await renderView(); }catch(e){ console.warn('initial load failed',e); } } })();
console.info('[admin] build v20251113g loaded');
